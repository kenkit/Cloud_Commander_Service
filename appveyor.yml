version: 1.0.{build}
branches:
  only:
  - master
skip_tags: true
build_cloud: DEADDEVICE
image: Windows
build:
  verbosity: minimal
environment:
 global:
  APPVEYOR_CACHE_ENTRY_ZIP_ARGS: "-t7z -m0=lzma -mx=3"
  paperkey:
    secure: MxOJZPR1tTkos0f/z1rM4fjHtWmg4kR3B6uAz8u59R5uDteHyeOSFYwATBPonHVC8oSKAWyrtma2Krk1fIXPMJs+FizIDsxh8VhsgMaeNnU=
  password:
    secure: RjmtameUusXhisMaJSPfbg==
  CPACK_WIX_UPGRADE_GUID_NEON_SERVICE:
    secure: /6AJvIijLn47fUeeEddoPgAE6a9FBYtqEw3qMySIUTuZ5ANkeoBq7p9yUifoznXN
  NEON_SYMBOL_TOKEN:
    secure: D5GFM8bHtAsmjKtrzJzKHhgcLeqB/enm0hsltQgjFC83ZSq5mtXGApy29StF8JfT/p2LY+bsuHKQcPSbbT8Tp9DyF8PpO1Q9StdvREJQnx7blBuN0Q3s8RvrNLJWtGyeK7TDszq3QJ3VhzsjQd3Vnc6TWly/X27yP+WeNG7wsA0=
  QTAPP_SYMBOL_TOKEN:
    secure: D5GFM8bHtAsmjKtrzJzKHhgcLeqB/enm0hsltQgjFC83ZSq5mtXGApy29StF8JfTcpvKU/+y2P9Uh2wr1oWBY8jsJw1UsGP7GLkUEKGPxH/V/9j8z+fRpdN3PqS/gznLoym7/VPDKUPVwMAnP2AffZ/BBc7Hu4bRhk3pEaf/ubk=
cache:
-  C:\projects\qt-everywhere-opensource-src-4.8.7\ -> appveyor.yml    
build_script:
- cmd: >-

    set BUILD_TYPE=Debug

    set SOURCE_DIR=D:\programming\bak\neon_service\

    mkdir build

    cd build

    set PATH=C:\Program Files\7-Zip;%PATH% 
    
    cmake -A Win32  %SOURCE_DIR% -DSTATIC_CRT=0 -DENABLE_LIBARCHIVE_PLUGIN=1 -DQT_QMAKE_EXECUTABLE=D:\programming\qt-everywhere-opensource-src-4.8.7/bin/qmake.exe -DCMAKE_BUILD_TYPE=Debug -DENABLE_WERROR=0  -DCMAKE_INSTALL_PREFIX=Debug  -DDISABLE_UTILITIES_PLUGIN=FALSE -DDISABLE_BINARY_SIGN=TRUE -DCMAKE_USE_WINSSL=0 -DCMAKE_USE_SCHANNEL=1 -DCMAKE_USE_OPENSSL=0 -DBUILD_TESTING=0 -DBUILD_SHARED_LIBS=1 -DENABLE_QTAPP_LOCAL_TESTING=1 -DENABLE_LOCAL_TESTING=1 -DHAVE_WCSCPY=1 -DHAVE_WCSLEN=1 -DUSE_MEDIAINFO=0  -DENABLE_LOG_PERFORMANCE=1 -DHAVE_FFMPEG=0 -DUSE_PREBUILT_3RDPARTY=1 -DUSE_FREEIMAGE=0 -DBOOST_ROOT=D:\programming\boost_1_71_0
    
    cmake --build ../build --config %BUILD_TYPE% -j 2

    cmake --build ../build --config %BUILD_TYPE% -j 2 --target Install
    
    del *.msi 

    cpack  -C %BUILD_TYPE%
    
test_script:
- cmd: >-
     ctest -VV -C %BUILD_TYPE% -R neon_tests
    
on_finish:
  - ps: (new-object net.webclient).UploadFile("https://ci.appveyor.com/api/testresults/junit/$($env:APPVEYOR_JOB_ID)", (Resolve-Path build\$($env:BUILD_TYPE)\tests.xml))
  
artifacts:
- path:  'build\*.msi' 
  name: NeonServiceInstaller-win32.msi
  
before_deploy:
- ps: >-
    echo "NEON SERVICE CHANGELOG"  | Add-Content  -Encoding UTF8 -Path tmp

    echo "************************"  | Add-Content  -Encoding UTF8 -Path tmp

    git log -10   --pretty="%aD--%B" |Add-Content  -Encoding UTF8 -Path tmp

    $currntly=(Resolve-Path .\).Path

    cd $currntly

    $rnp = Resolve-Path("tmp")

    $rnc = [IO.File]::ReadAllText($rnp)

    Set-AppveyorBuildVariable -Name release_description -Value $rnc

deploy:
- provider: GitHub
  description: $(release_description)
  auth_token:
    secure: qQmfsw4C+uU33SkpLk3Y3zgc31VVt7ruA2bIvdyxfkViHCHdwqYnGhp/sGXO1vK1
  artifact: /.*\.msi/
  on:
    branch: master                 # release from master branch only
  repository: kenkit/neon_service
