version: 1.0.{build}
branches:
  only:
  - master
skip_tags: true
build:
  verbosity: minimal
image: Visual Studio 2017
environment:
 global:
  paperkey:
    secure: MxOJZPR1tTkos0f/z1rM4fjHtWmg4kR3B6uAz8u59R5uDteHyeOSFYwATBPonHVC8oSKAWyrtma2Krk1fIXPMJs+FizIDsxh8VhsgMaeNnU=
build_script:
- cmd: >-
    curl -fsS -o keybase_setup_amd64.msi "https://prerelease.keybase.io/keybase_setup_amd64.msi"
    
    curl -fsS -o qt-everywhere-opensource-src-4.8.7_build.zip "https://github.com/kenkit/Cloud_Commander_UI/blob/master/qt-everywhere-opensource-src-4.8.7_build.zip?raw=true"

    7z e qt-everywhere-opensource-src-4.8.7_build.zip
    
    set PATH=%PATH%;%cd%qt-everywhere-opensource-src-4.8.7_build
    
    start /wait msiexec.exe /i keybase_setup_amd64.msi   /quiet /l*v keybase.log

    REM type keybase.log
    
    set PATH=%PATH%;%localappdata%\Keybase\

    keybase -v

    echo "loging in to keybase"

    keybase oneshot -u kenkit --paperkey "%paperkey%"
    
    git config --global --add protocol.keybase.allow always

    git clone keybase://private/kenkit/neon_service 
    
    cd neon_service 
    
    git submodule update --init --recursive

    mkdir build
    
    cd build

    cmake ../  -DBOOST_ROOT=C:\Libraries\boost_1_67_0
    
    cmake --build ../build 

before_deploy:
- ps: >-
    echo "NEON SERVICE CHANGELOG"  | Add-Content  -Encoding UTF8 -Path tmp

    echo "************************"  | Add-Content  -Encoding UTF8 -Path tmp

    git log -10   --pretty="%aD--%B" |Add-Content  -Encoding UTF8 -Path tmp

    $currntly=(Resolve-Path .\).Path

    cd $currntly

    $rnp = Resolve-Path("tmp")

    $rnc = [IO.File]::ReadAllText($rnp)

    Set-AppveyorBuildVariable -Name release_description -Value $rnc


  
